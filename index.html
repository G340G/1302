<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CHANNEL_9 // THE_GLASS_BARRIER</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=VT323&display=swap');
        body, html { margin: 0; padding: 0; background: #020202; overflow: hidden; cursor: none; }
        #viewport { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { width: 100%; height: 100%; object-fit: contain; filter: contrast(1.3) saturate(0.6) brightness(1.1); image-rendering: pixelated; }

        /* PHYSICAL DISTORTION */
        .vhs-mesh { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.04));
            background-size: 100% 2px, 2px 100%; }
        
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; color: #0f0; font-family: 'VT323', monospace; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .monitor { width: 600px; padding: 20px; border: 1px solid #0f0; box-shadow: 0 0 15px #0f0; }
        button { background: #0f0; color: #000; border: none; padding: 15px 40px; font-family: 'Archivo Black', sans-serif; font-size: 1.2rem; cursor: pointer; margin-top: 20px; display: none; }
        #prog { position: absolute; bottom: 0; left: 0; height: 4px; background: #0f0; width: 0%; z-index: 200; }
    </style>
</head>
<body>

<div id="ui">
    <div class="monitor">
        [SYS] SIGNAL_RECOVERY: 88%...<br>
        [SYS] SOURCE: UNKNOWN (VHF_BAND_4)<br>
        [SYS] WARNING: THE GLASS IS THINNING.<br>
        [SYS] DO NOT RESPOND TO THE ANCHOR.
    </div>
    <button id="start-btn">OBSERVE FEED</button>
</div>

<div id="viewport">
    <div class="vhs-mesh"></div>
    <div id="prog"></div>
    <canvas id="c"></canvas>
</div>

<script>
(function() {
    "use strict";

    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha: false });
    const startBtn = document.getElementById("start-btn");
    const prog = document.getElementById("prog");

    canvas.width = 1280;
    canvas.height = 720;

    let state = {
        active: false,
        frame: 0,
        maxFrames: 2400, // 40 Seconds
        keyword: "",
        wiki: "",
        images: [],
        prox: 0,
        recorder: null,
        chunks: [],
        audio: { ctx: null, dest: null, master: null }
    };

    const LORE_TEXT = [
        "HE HAS PASSED THE FIRST GATE.",
        "THE BROADCAST IS THE BAIT.",
        "CAN YOU HEAR THE FOOTSTEPS IN THE STATIC?",
        "THE GLASS IS THE ONLY BARRIER.",
        "HE IS BEHIND THE PLASTIC CASING."
    ];

    const JARGON = ["0xGHOST_VAL", "SIG_STRENGTH_ERR", "VOID_RECURSION", "DEATH_ALLOC_NULL"];

    async function init() {
        const concepts = ["Liminality", "Necrosis", "Totalitarianism", "Entropy", "Obsolescence"];
        state.keyword = concepts[Math.floor(Math.random() * concepts.length)];
        try {
            const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${state.keyword}`);
            const d = await r.json();
            state.wiki = (d.extract || "SIGNAL LOST").toUpperCase();
        } catch { state.wiki = "THE VOID HAS REPLACED THE ARCHIVE."; }

        for(let i=0; i<4; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = `https://picsum.photos/seed/${Math.random()}/800/600?grayscale`;
            state.images.push(img);
        }
        startBtn.style.display = "block";
    }

    // --- MARTIAL ATONAL MUSIC ---
    function setupAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audio.ctx = new AC();
        state.audio.dest = state.audio.ctx.createMediaStreamDestination();
        state.audio.master = state.audio.ctx.createGain();
        state.audio.master.connect(state.audio.dest);
        state.audio.master.connect(state.audio.ctx.destination);

        const sr = state.audio.ctx.sampleRate;

        // Martial Beat Loop
        setInterval(() => {
            if(!state.active) return;
            // Distorted Kick
            const kick = state.audio.ctx.createOscillator();
            const kg = state.audio.ctx.createGain();
            kick.frequency.setValueAtTime(60, state.audio.ctx.currentTime);
            kick.frequency.exponentialRampToValueAtTime(0.01, state.audio.ctx.currentTime + 0.5);
            kg.gain.setValueAtTime(0.3, state.audio.ctx.currentTime);
            kg.gain.linearRampToValueAtTime(0, state.audio.ctx.currentTime + 0.4);
            kick.connect(kg).connect(state.audio.master);
            kick.start(); kick.stop(state.audio.ctx.currentTime + 0.5);
        }, 600); // Off-beat 4/4

        // Atonal Drone
        const drones = [113, 239, 307]; // Prime numbers for atonality
        drones.forEach(f => {
            const osc = state.audio.ctx.createOscillator();
            const g = state.audio.ctx.createGain();
            osc.frequency.value = f;
            g.gain.value = 0.05;
            osc.connect(g).connect(state.audio.master);
            osc.start();
        });
    }

    function drawFiend(alpha) {
        ctx.save();
        ctx.globalAlpha = alpha;
        // The fiend is a crawling silhouette
        const x = 400 + Math.sin(state.frame * 0.05) * 20;
        const y = 350 + (state.prox * 100); // Slowly crawling down/forward
        ctx.translate(x, y);
        ctx.scale(0.5 + state.prox, 0.5 + state.prox);
        
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.moveTo(-50, 0); ctx.quadraticCurveTo(0, -150, 50, 0); // Head/Shoulders
        ctx.fill();

        // Glowing white pin-prick eyes
        ctx.fillStyle = "#fff";
        const blink = Math.random() > 0.03 ? 1 : 0;
        ctx.fillRect(-15, -60, 4 * blink, 4);
        ctx.fillRect(15, -60, 4 * blink, 4);
        ctx.restore();
    }

    function render() {
        if(!state.active) return;
        state.frame++;
        state.prox = state.frame / state.maxFrames;
        prog.style.width = (state.prox * 100) + "%";

        // Bruised Background
        const r = Math.floor(state.prox * 40);
        const b = Math.floor(80 - (state.prox * 40));
        ctx.fillStyle = `rgb(${r}, 0, ${b})`;
        ctx.fillRect(0,0,1280,720);

        // Slide Cycles
        const cycle = state.frame % 800;
        if(cycle < 400) {
            // "THE ANCHOR"
            ctx.fillStyle = "#000"; ctx.fillRect(150, 100, 500, 350);
            ctx.strokeStyle = "#fff"; ctx.strokeRect(150, 100, 500, 350);
            
            // The Fiend hides in the Anchor Box
            drawFiend(state.prox * 0.7);

            // Lower Third (Flickering)
            if(Math.random() > 0.05) {
                ctx.fillStyle = "#500"; ctx.fillRect(50, 500, 800, 80);
                ctx.fillStyle = "#fff"; ctx.font = "bold 35px Archivo Black";
                ctx.fillText(`CHANNEL 9 // ${state.keyword}`, 80, 555);
            }
        } else {
            // "DISTORTED ARCHIVE"
            const img = state.images[Math.floor(state.frame/400)%4];
            if(img.complete) {
                ctx.save();
                ctx.translate(640, 360);
                const zoom = 1 + (state.prox * 0.5);
                ctx.scale(zoom, zoom);
                // Pixel sort effect (fake)
                if(Math.random() > 0.9) ctx.translate(Math.random()*10, 0);
                ctx.drawImage(img, -400, -300, 800, 600);
                ctx.restore();
            }

            // Lore Text Overlay
            ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(0, 300, 1280, 120);
            ctx.fillStyle = "#fff"; ctx.font = "40px VT323"; ctx.textAlign = "center";
            ctx.fillText(LORE_TEXT[Math.floor(state.frame/200)%5], 640, 370);
        }

        // Ticker
        ctx.fillStyle = "#000"; ctx.fillRect(0, 660, 1280, 60);
        ctx.fillStyle = "#ff0"; ctx.font = "24px VT323"; ctx.textAlign = "left";
        const tickerMsg = `[STATION_9] : ${state.wiki} | ${JARGON[Math.floor(state.frame/100)%4]} | [DECODE: HE_IS_WATCHING]`;
        ctx.fillText(tickerMsg, 1280 - (state.frame*7 % 6000), 700);

        // Subliminal Tree
        ctx.globalAlpha = 0.1;
        ctx.save(); ctx.translate(1100, 200);
        function drawTree(l, d) {
            if(d<=0) return;
            ctx.strokeStyle = "#fff"; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-l); ctx.stroke();
            ctx.translate(0,-l);
            ctx.save(); ctx.rotate(0.5); drawTree(l*0.8, d-1); ctx.restore();
            ctx.save(); ctx.rotate(-0.5); drawTree(l*0.8, d-1); ctx.restore();
        }
        drawTree(30, 5); ctx.restore(); ctx.globalAlpha = 1.0;

        // Glitch & Jumpscare
        if(Math.random() > 0.99 - (state.prox * 0.02)) {
            const h = Math.random() * 100;
            ctx.drawImage(canvas, 0, Math.random()*720, 1280, h, Math.random()*100-50, Math.random()*720, 1280, h);
            if(state.prox > 0.9) {
                ctx.fillStyle = "#fff"; ctx.fillRect(0,0,1280,720); // FINAL BLINDING
            }
        }

        if(state.frame < state.maxFrames) requestAnimationFrame(render);
        else finish();
    }

    async function start() {
        document.getElementById("ui").style.display = "none";
        setupAudio();
        const stream = canvas.captureStream(60);
        const combined = new MediaStream([...stream.getVideoTracks(), ...state.audio.dest.stream.getAudioTracks()]);
        state.recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        state.recorder.ondataavailable = e => state.chunks.push(e.data);
        state.recorder.onstop = save;
        state.recorder.start(100);
        state.active = true;
        render();

        const msg = new SpeechSynthesisUtterance("The following is a mandatory announcement. The glass is thin. He is no longer in the signal. He is in the room.");
        msg.pitch = 0.1; msg.rate = 0.8;
        window.speechSynthesis.speak(msg);
    }

    function finish() { state.active = false; state.recorder.stop(); }

    function save() {
        const b = new Blob(state.chunks, { type: 'video/webm' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = `STATION9_THE_BARRIER_${state.keyword}.webm`;
        a.click();
        setTimeout(() => window.location.reload(), 3000);
    }

    init();
    startBtn.addEventListener("click", start);
})();
</script>
</body>
</html>
