<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>STATION_9 // COMPLIANCE_V19</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=VT323&display=swap');
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; cursor: crosshair; }
        #viewport { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { width: 100%; height: 100%; object-fit: contain; filter: contrast(1.5) saturate(0.4) sepia(0.2); image-rendering: pixelated; }
        
        .vhs-lines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.3) 50%); background-size: 100% 4px; opacity: 0.6; }
        
        #ui-boot { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000088; z-index: 100; color: #fff; font-family: 'VT323', monospace; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .slide-btn { background: #fff; color: #000088; border: none; padding: 15px 40px; font-weight: bold; cursor: pointer; display: none; margin-top: 20px; }
        #dl-status { position: fixed; bottom: 10px; right: 10px; color: #f00; font-family: monospace; z-index: 200; font-size: 12px; }
    </style>
</head>
<body>

<div id="ui-boot">
    <div style="font-size: 2rem; border: 2px solid #fff; padding: 20px;">
        CORPORATE TRAINING MODULE V19.0.4<br>
        SUBJECT: <span id="subject-tag">...</span><br>
        [CLASSIFIED - DO NOT DISTRIBUTE]
    </div>
    <button id="start-btn" class="slide-btn">BEGIN PRESENTATION</button>
</div>

<div id="viewport">
    <div class="vhs-lines"></div>
    <div id="dl-status"></div>
    <canvas id="c"></canvas>
</div>

<script>
(function() {
    "use strict";

    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha: false });
    const startBtn = document.getElementById("start-btn");
    const dlStatus = document.getElementById("dl-status");

    canvas.width = 1280;
    canvas.height = 720;

    let state = {
        active: false,
        frame: 0,
        maxFrames: 3000, // ~50 Seconds
        keyword: "",
        wiki: "",
        images: [],
        seed: Math.random(),
        recorder: null,
        chunks: [],
        audio: { ctx: null, dest: null, master: null }
    };

    // 1. Million-Word Concept Generator
    const P = ["Recursive", "Involuntary", "Mandatory", "Subliminal", "Genetic", "Hysterical", "Atonal"];
    const R = ["Compliance", "Flesh", "Transmission", "Protocol", "Nervous_System", "Organism"];
    const S = ["Ascension", "Decay", "Stasis", "Transfusion", "Nullification"];

    async function init() {
        state.keyword = `${P[Math.floor(Math.random()*P.length)]}_${R[Math.floor(Math.random()*R.length)]}_${S[Math.floor(Math.random()*S.length)]}`;
        document.getElementById("subject-tag").innerText = state.keyword;

        try {
            const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${R[Math.floor(Math.random()*R.length)]}`);
            const d = await r.json();
            state.wiki = (d.extract || "DATA_MISSING").toUpperCase();
        } catch { state.wiki = "THE ARCHIVE HAS BEEN PURGED FOR YOUR PROTECTION."; }

        for(let i=0; i<8; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = `https://picsum.photos/seed/${Math.random()}/800/600?grayscale`;
            state.images.push(img);
        }
        startBtn.style.display = "block";
    }

    // 2. Audio: Martial/Atonal/Industrial
    function setupAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audio.ctx = new AC();
        state.audio.dest = state.audio.ctx.createMediaStreamDestination();
        state.audio.master = state.audio.ctx.createGain();
        state.audio.master.connect(state.audio.dest);
        state.audio.master.connect(state.audio.ctx.destination);

        // Industrial March
        setInterval(() => {
            if(!state.active) return;
            const kick = state.audio.ctx.createOscillator();
            const g = state.audio.ctx.createGain();
            kick.frequency.setValueAtTime(55, state.audio.ctx.currentTime);
            kick.frequency.exponentialRampToValueAtTime(0.01, state.audio.ctx.currentTime + 0.4);
            g.gain.setValueAtTime(0.3, state.audio.ctx.currentTime);
            g.gain.linearRampToValueAtTime(0, state.audio.ctx.currentTime + 0.4);
            kick.connect(g).connect(state.audio.master);
            kick.start(); kick.stop(state.audio.ctx.currentTime + 0.4);
        }, 700);
    }

    // 3. Visuals: 80s Corporate PPT Style
    function drawPolaroid(img, x, y, rot) {
        ctx.save();
        ctx.translate(x, y); ctx.rotate(rot);
        ctx.fillStyle = "#eee"; ctx.fillRect(-220, -250, 440, 500); // Border
        ctx.fillStyle = "#000"; ctx.fillRect(-200, -230, 400, 350); // Image Area
        if(img.complete) ctx.drawImage(img, -200, -230, 400, 350);
        ctx.fillStyle = "#222"; ctx.font = "20px 'VT323'";
        ctx.fillText("FILE_ID: " + Math.random().toString(16).slice(2,8), -180, 200);
        ctx.restore();
    }

    function render() {
        if(!state.active) return;
        state.frame++;
        const p = state.frame / state.maxFrames;

        // Background: Dirty Beige / Corporate Blue
        ctx.fillStyle = (state.frame % 1000 < 500) ? "#cfc4a6" : "#000055";
        ctx.fillRect(0,0,1280,720);

        // Slide Content Logic
        if(state.frame % 800 < 400) {
            // SLIDE TYPE A: Text Heavy
            ctx.fillStyle = "#000"; ctx.font = "bold 50px 'Archivo Black'";
            ctx.fillText("MODULE: " + state.keyword, 100, 100);
            
            ctx.font = "24px 'VT323'";
            const lines = state.wiki.match(/.{1,60}(\s|$)/g) || [];
            lines.slice(0, 15).forEach((l, i) => {
                // Redaction Easter Egg
                if(Math.random() > 0.95) ctx.fillStyle = "#000";
                else ctx.fillStyle = "#333";
                ctx.fillText(l, 100, 200 + (i*30));
            });
        } else {
            // SLIDE TYPE B: Visual Evidence
            const curImg = state.images[Math.floor(state.frame/400) % 8];
            drawPolaroid(curImg, 640, 360, Math.sin(state.frame*0.01)*0.1);
        }

        // The Fiend (Shadow Stalker)
        ctx.globalAlpha = p * 0.4;
        ctx.fillStyle = "#000";
        ctx.beginPath(); ctx.arc(1200 - (p*200), 100 + (p*100), 50 + (p*100), 0, 7); ctx.fill();
        ctx.globalAlpha = 1.0;

        // Corporate Ticker
        ctx.fillStyle = "#000"; ctx.fillRect(0, 670, 1280, 50);
        ctx.fillStyle = "#fff"; ctx.font = "20px 'VT323'";
        ctx.fillText("DO NOT SPEAK TO OTHER EMPLOYEES ABOUT " + state.keyword + " | STATUS: ENFORCING | ", 1280 - (state.frame*5 % 5000), 700);

        // Final Jumpscare / Glitch
        if(p > 0.95 && Math.random() > 0.9) {
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,1280,720);
        }

        if(state.frame < state.maxFrames) requestAnimationFrame(render);
        else finish();
    }

    // 4. Engine Controls & Fixed Download
    async function start() {
        document.getElementById("ui-boot").style.display = "none";
        setupAudio();
        
        const stream = canvas.captureStream(60);
        const combined = new MediaStream([...stream.getVideoTracks(), ...state.audio.dest.stream.getAudioTracks()]);

        state.recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        state.recorder.ondataavailable = e => { if(e.data.size > 0) state.chunks.push(e.data); };
        
        state.recorder.onstop = () => {
            dlStatus.innerText = "PACKAGING TRANSMISSION...";
            const blob = new Blob(state.chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `STATION9_COMPLIANCE_${state.keyword}.webm`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.location.reload();
            }, 5000); // Give plenty of time for the download to trigger
        };

        state.recorder.start(100);
        state.active = true;
        render();

        const msg = new SpeechSynthesisUtterance("Welcome to the Station 9 Compliance Module. Regarding " + state.keyword + ". This information is mandatory for your survival. Do not blink.");
        msg.lang = 'en-US'; msg.pitch = 0.5; msg.rate = 0.85;
        window.speechSynthesis.speak(msg);
    }

    function finish() {
        state.active = false;
        state.recorder.stop();
        dlStatus.innerText = "UPLOADING TO ARCHIVE...";
    }

    init();
    startBtn.addEventListener("click", start);
})();
</script>
</body>
</html>
