<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CHANNEL_9 // SEPHIROTH_V15</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&display=swap');
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Archivo Black', sans-serif; cursor: none; }
        #viewport { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { width: 100%; height: 100%; object-fit: contain; filter: contrast(1.1) saturate(0.9); image-rendering: pixelated; }
        
        /* CRT & VHS PHYSICALITY */
        .vhs { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 3px, 3px 100%; }
        .scanline { position: absolute; width: 100%; height: 100px; background: rgba(255,255,255,0.05); filter: blur(10px); z-index: 11; animation: slide 10s infinite linear; }
        @keyframes slide { 0% { top: -20%; } 100% { top: 120%; } }

        /* TERMINAL BOOT */
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000088; z-index: 100; 
              display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; font-family: monospace; }
        .msg { text-align: center; margin-bottom: 20px; line-height: 1.5; letter-spacing: 2px; }
        button { background: #fff; color: #000088; border: none; padding: 15px 50px; font-weight: bold; cursor: pointer; display: none; }
        #progress-line { position: absolute; bottom: 0; left: 0; height: 10px; background: #f00; width: 0%; z-index: 200; }
    </style>
</head>
<body>

<div id="ui">
    <div class="msg" id="boot-log">
        SYS_VER: 15.0.4<br>
        LOCATING NEURAL ANCHOR...<br>
        [SEARCHING WIKIMEDIA DOMAIN]
    </div>
    <button id="start-btn">ENGAGE BROADCAST</button>
</div>

<div id="viewport">
    <div class="vhs"></div>
    <div class="scanline"></div>
    <div id="progress-line"></div>
    <canvas id="c"></canvas>
</div>

<script>
(function() {
    "use strict";

    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha: false });
    const startBtn = document.getElementById("start-btn");
    const bootLog = document.getElementById("boot-log");
    const progressLine = document.getElementById("progress-line");

    canvas.width = 1280;
    canvas.height = 720;

    let state = {
        active: false,
        frame: 0,
        maxFrames: 2400,
        keyword: "",
        wiki: "",
        images: [],
        recorder: null,
        chunks: [],
        audio: { ctx: null, dest: null, master: null }
    };

    const CONCEPTS = ["Dementia", "Hysteria", "Obsolescence", "Radiation", "Pestilence", "Automation", "Despair", "Tapping"];

    // --- 1. THE BRAIN (Scraping & Seeding) ---
    async function init() {
        state.keyword = CONCEPTS[Math.floor(Math.random() * CONCEPTS.length)];
        
        try {
            const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${state.keyword}`);
            const d = await r.json();
            state.wiki = (d.extract || "NO SIGNAL FOUND").toUpperCase();
            bootLog.innerHTML += `<br>ANCHOR: ${state.keyword}<br>BUFFER: READY`;
        } catch { 
            state.wiki = "THE SIGNAL IS INTERRUPTED BY BURIED FREQUENCIES."; 
            bootLog.innerHTML += `<br>WIKI_ERROR: FALLBACK_LOADED`;
        }

        for(let i=0; i<3; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = `https://picsum.photos/seed/${Math.random()}/640/480?grayscale`;
            state.images.push(img);
        }

        setTimeout(() => { startBtn.style.display = "block"; }, 1000);
    }

    // --- 2. THE AUDIO (Fixed Instance Error) ---
    function setupAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audio.ctx = new AC();
        state.audio.dest = state.audio.ctx.createMediaStreamDestination();
        state.audio.master = state.audio.ctx.createGain();
        state.audio.master.connect(state.audio.dest);
        state.audio.master.connect(state.audio.ctx.destination);

        // Bumper Jingle
        const jingle = state.audio.ctx.createOscillator();
        jingle.type = 'triangle';
        jingle.frequency.setValueAtTime(440, state.audio.ctx.currentTime);
        jingle.frequency.exponentialRampToValueAtTime(110, state.audio.ctx.currentTime + 2);
        const jG = state.audio.ctx.createGain();
        jG.gain.setValueAtTime(0.2, state.audio.ctx.currentTime);
        jG.gain.linearRampToValueAtTime(0, state.audio.ctx.currentTime + 2);
        jingle.connect(jG).connect(state.audio.master);
        jingle.start();

        // 80s Noise Floor (The Fix)
        const sr = state.audio.ctx.sampleRate;
        const buffer = state.audio.ctx.createBuffer(1, sr * 2, sr);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < sr * 2; i++) data[i] = Math.random() * 2 - 1;
        const noise = state.audio.ctx.createBufferSource();
        noise.buffer = buffer; noise.loop = true;
        const nG = state.audio.ctx.createGain(); nG.gain.value = 0.03;
        noise.connect(nG).connect(state.audio.master);
        noise.start();
    }

    function scare() {
        const o = state.audio.ctx.createOscillator();
        const g = state.audio.ctx.createGain();
        o.type = 'sawtooth'; o.frequency.value = 60;
        o.frequency.exponentialRampToValueAtTime(10, state.audio.ctx.currentTime + 0.3);
        g.gain.setValueAtTime(0.5, state.audio.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, state.audio.ctx.currentTime + 0.3);
        o.connect(g).connect(state.audio.master);
        o.start(); o.stop(state.audio.ctx.currentTime + 0.3);
    }

    // --- 3. VISUALS (The 80s Broadcast) ---
    function drawTree(x, y, s) {
        ctx.save(); ctx.translate(x, y); ctx.scale(s, s); ctx.strokeStyle = "#fff";
        function b(l, a, d) {
            if(d<=0) return;
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-l); ctx.stroke();
            ctx.save(); ctx.translate(0,-l); ctx.rotate(a); b(l*0.8, a, d-1); ctx.restore();
            ctx.save(); ctx.translate(0,-l); ctx.rotate(-a); b(l*0.8, a, d-1); ctx.restore();
        }
        b(40, 0.5 + Math.sin(state.frame*0.03)*0.1, 6);
        ctx.restore();
    }

    function render() {
        if(!state.active) return;
        state.frame++;
        progressLine.style.width = (state.frame / state.maxFrames * 100) + "%";

        // Background (Deep TV Blue)
        ctx.fillStyle = "#000055";
        ctx.fillRect(0,0,1280,720);

        if(state.frame % 800 < 500) {
            // "ANCHOR" MODE
            ctx.fillStyle = "#000"; ctx.fillRect(100, 100, 600, 400); // Box
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 4; ctx.strokeRect(100, 100, 600, 400);

            // The Fiend (Procedural Face)
            ctx.save(); ctx.translate(400, 350);
            ctx.fillStyle = "#111"; ctx.beginPath(); ctx.arc(0,0,80,0,6.28); ctx.fill();
            ctx.fillStyle = "#fff"; 
            if(Math.random() > 0.05) { ctx.fillRect(-40, -20, 30, 4); ctx.fillRect(10, -20, 30, 4); }
            ctx.restore();

            // Lower Third
            ctx.fillStyle = "#990000"; ctx.fillRect(50, 520, 750, 80);
            ctx.fillStyle = "#fff"; ctx.font = "bold 35px Arial";
            ctx.fillText("CHANNEL 9 NEWS: " + state.keyword, 80, 575);

            // Side Visual
            const cur = state.images[Math.floor(state.frame/300) % 3];
            if(cur.complete) {
                ctx.drawImage(cur, 800, 100, 400, 300);
                ctx.strokeRect(800, 100, 400, 300);
            }
        } else {
            // "EMERGENCY" MODE
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,1280,720);
            ctx.fillStyle = "#fff"; ctx.font = "18px Courier New";
            const lines = state.wiki.match(/.{1,70}(\s|$)/g) || [];
            lines.slice(0, 22).forEach((l, i) => ctx.fillText(l, 80, 80 + (i*25)));
            
            if(Math.random() > 0.98) {
                ctx.fillStyle = "#fff"; ctx.fillRect(0,0,1280,720);
                scare();
            }
        }

        // Ticker
        ctx.fillStyle = "#000"; ctx.fillRect(0, 650, 1280, 70);
        ctx.fillStyle = "#FFFF00"; ctx.font = "bold 25px Arial";
        ctx.fillText("TICKER: [MEM_ADDR_FAIL] " + state.wiki, 1280 - (state.frame*5 % 5000), 695);

        drawTree(1180, 620, 0.4);

        if(Math.random() > 0.97) ctx.drawImage(canvas, 0, Math.random()*720, 1280, 2, Math.random()*20-10, Math.random()*720, 1280, 2);

        if(state.frame < state.maxFrames) requestAnimationFrame(render);
        else finish();
    }

    async function start() {
        document.getElementById("ui").style.display = "none";
        setupAudio();
        const stream = canvas.captureStream(60);
        const combined = new MediaStream([...stream.getVideoTracks(), ...state.audio.dest.stream.getAudioTracks()]);
        state.recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        state.recorder.ondataavailable = e => state.chunks.push(e.data);
        state.recorder.onstop = save;
        state.recorder.start(100);
        state.active = true;
        render();

        const utter = new SpeechSynthesisUtterance("Channel 9 News Broadcast. Warning. Severe data corruption detected in the " + state.keyword + " sector. Please remain calm.");
        utter.lang = 'en-US'; utter.pitch = 0.5; utter.rate = 0.8;
        window.speechSynthesis.speak(utter);
    }

    function finish() { state.active = false; state.recorder.stop(); }

    function save() {
        const b = new Blob(state.chunks, { type: 'video/webm' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = `BROADCAST_CORRUPT_${state.keyword}.webm`;
        a.click();
        setTimeout(() => window.location.reload(), 3000);
    }

    init();
    startBtn.addEventListener("click", start);
})();
</script>
</body>
</html>
