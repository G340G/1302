<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>STATION_9 // THE_ARCHIVAL_RITUAL_V20</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=VT323&display=swap');
        body, html { margin: 0; padding: 0; background: #050505; overflow: hidden; cursor: none; }
        #viewport { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { width: 100%; height: 100%; object-fit: contain; filter: contrast(1.6) saturate(0.3) brightness(1.1); image-rendering: pixelated; }
        
        /* CRT SHADER OVERLAY */
        .vhs-bloom { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.4) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.08), rgba(0, 255, 0, 0.03), rgba(0, 0, 255, 0.08));
            background-size: 100% 3px, 3px 100%; mix-blend-mode: screen; }
        
        #ui-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; color: #fff; font-family: 'VT323', monospace; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .monitor-frame { border: 10px solid #222; background: #000044; padding: 40px; box-shadow: inset 0 0 50px #000; text-align: left; width: 700px; }
        button { background: #fff; color: #000044; border: none; padding: 20px 60px; font-family: 'Archivo Black', sans-serif; font-size: 1.5rem; cursor: pointer; margin-top: 30px; display: none; transition: 0.3s; }
        button:hover { background: #ff0000; color: #fff; }
    </style>
</head>
<body>

<div id="ui-gate">
    <div class="monitor-frame">
        > STATION_9 INTERCEPT... [LOADED]<br>
        > 27,000,000+ PERMUTATIONS DETECTED.<br>
        > SUBJECT: <span id="keyword-display" style="color:#ff0;">...</span><br>
        > WARNING: DO NOT RECORD THE AUDIO COMPONENT.<br>
        > THE FIEND IS OBSERVING THIS HANDSHAKE.
    </div>
    <button id="start-btn">INITIALIZE RITUAL</button>
</div>

<div id="viewport">
    <div class="vhs-bloom"></div>
    <canvas id="c"></canvas>
</div>

<script>
(function() {
    "use strict";

    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha: false });
    const startBtn = document.getElementById("start-btn");

    canvas.width = 1280;
    canvas.height = 720;

    let state = {
        active: false,
        frame: 0,
        maxFrames: 3600, // 60 Seconds
        keyword: "",
        wikiTexts: [],
        images: [],
        prox: 0,
        recorder: null,
        chunks: [],
        audio: { ctx: null, dest: null, master: null }
    };

    // --- 1. THE 27-MILLION COMBINATION BRAIN ---
    const ADJ = ["Extradimensional", "Non-Euclidean", "Mandatory", "Visceral", "Dormant", "Cytotoxic", "Subterranean", "Obsessive", "Fungal", "Post-Human", "Logarithmic", "Bleeding", "Silent", "Inverted"];
    const SUB = ["Vessel", "Nerve", "Architecture", "Pulse", "Constraint", "Aperture", "Marrow", "Lattice", "Protocol", "Echo", "Fluid", "Gland", "Threshold"];
    const ACT = ["Convergence", "Nullification", "Erosion", "Saturation", "Bleed", "Harvest", "Compliance", "Collapse", "Transfusion", "Inhabitation"];

    async function init() {
        state.keyword = `${ADJ[Math.floor(Math.random()*ADJ.length)]} ${SUB[Math.floor(Math.random()*SUB.length)]} ${ACT[Math.floor(Math.random()*ACT.length)]}`;
        document.getElementById("keyword-display").innerText = state.keyword;

        // Scrape 3 random wiki entries for depth
        const seeds = [SUB[Math.floor(Math.random()*SUB.length)], "Entomology", "Parapsychology"];
        for(let s of seeds) {
            try {
                const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${s}`);
                const d = await r.json();
                state.wikiTexts.push((d.extract || "EMPTY").toUpperCase());
            } catch { state.wikiTexts.push("THE SIGNAL IS TOO WEAK TO DECODE."); }
        }

        // Scrape complex images
        for(let i=0; i<10; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = `https://picsum.photos/seed/${Math.random()}/1024/768?grayscale`;
            state.images.push(img);
        }
        startBtn.style.display = "block";
    }

    // --- 2. MULTI-INSTRUMENT ATONAL MUSIC ---
    function setupAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audio.ctx = new AC();
        state.audio.dest = state.audio.ctx.createMediaStreamDestination();
        state.audio.master = state.audio.ctx.createGain();
        state.audio.master.connect(state.audio.dest);
        state.audio.master.connect(state.audio.ctx.destination);

        // Industrial Martial Beat
        setInterval(() => {
            if(!state.active) return;
            const time = state.audio.ctx.currentTime;
            playNote(60, 'square', 0.2, 0.4); // Bass Drum
            if(state.frame % 60 < 10) playNote(1200, 'sawtooth', 0.05, 0.1); // Metallic Snare
        }, 600);

        // Atonal Melody (The Ritual)
        const scale = [130.81, 155.56, 185.00, 220.00, 261.63]; // C Minor Diminished
        setInterval(() => {
            if(!state.active) return;
            const freq = scale[Math.floor(Math.random()*scale.length)];
            playNote(freq, 'triangle', 0.1, 1.5);
        }, 1200);
    }

    function playNote(freq, type, vol, len) {
        const o = state.audio.ctx.createOscillator();
        const g = state.audio.ctx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, state.audio.ctx.currentTime);
        g.gain.setValueAtTime(vol, state.audio.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, state.audio.ctx.currentTime + len);
        o.connect(g).connect(state.audio.master);
        o.start(); o.stop(state.audio.ctx.currentTime + len);
    }

    // --- 3. THE FIEND & DISTORTED VISUALS ---
    function drawFiend(p) {
        ctx.save();
        ctx.globalAlpha = p * 0.5;
        ctx.fillStyle = "#000";
        const jitter = Math.random() * 10;
        ctx.translate(640 + jitter, 360);
        ctx.scale(1 + p*3, 1 + p*3);
        
        // Procedural body
        ctx.beginPath();
        ctx.moveTo(-50, 100);
        ctx.bezierCurveTo(-100, -200, 100, -200, 50, 100);
        ctx.fill();
        
        // Eyes
        ctx.fillStyle = "#fff";
        if(Math.random() > 0.05) {
            ctx.fillRect(-20, -120, 15, 2); ctx.fillRect(10, -120, 15, 2);
        }
        ctx.restore();
    }

    function render() {
        if(!state.active) return;
        state.frame++;
        state.prox = state.frame / state.maxFrames;

        // Draw Background (Sickly Green/Grey)
        ctx.fillStyle = "#1a1c1a";
        ctx.fillRect(0,0,1280,720);

        // Dynamic Layouts
        const scene = Math.floor(state.frame / 600) % 3;

        if(scene === 0) {
            // CORPORATE DATA
            ctx.fillStyle = "#000"; ctx.fillRect(50, 50, 1180, 620);
            ctx.strokeStyle = "#fff"; ctx.strokeRect(60, 60, 1160, 600);
            ctx.fillStyle = "#fff"; ctx.font = "bold 40px Archivo Black";
            ctx.fillText("PROTOCOL: " + state.keyword, 100, 120);
            
            ctx.font = "20px VT323";
            const txt = state.wikiTexts[0] || "";
            const lines = txt.match(/.{1,90}(\s|$)/g) || [];
            lines.slice(0, 15).forEach((l, i) => ctx.fillText(l, 100, 200 + (i*25)));
        } else if(scene === 1) {
            // POLAROID CORRUPTION
            const img = state.images[Math.floor(state.frame/100) % 10];
            ctx.save();
            ctx.translate(640, 360);
            ctx.rotate(Math.sin(state.frame*0.02)*0.1);
            // Polaroid Frame
            ctx.fillStyle = "#ddd"; ctx.fillRect(-320, -320, 640, 640);
            ctx.fillStyle = "#000";
            if(img.complete) {
                // Melting effect
                ctx.drawImage(img, -300, -300, 600, 450);
                if(Math.random() > 0.8) {
                    ctx.fillStyle = "rgba(0,0,0,0.5)";
                    ctx.fillRect(-300, -300 + (Math.random()*450), 600, 20);
                }
            }
            ctx.fillStyle = "#222"; ctx.font = "30px VT323";
            ctx.fillText("SUBJECT_REF_" + state.frame, -280, 250);
            ctx.restore();
        } else {
            // THE FIEND REVEAL
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,1280,720);
            drawFiend(state.prox);
            ctx.fillStyle = "#fff"; ctx.font = "50px Archivo Black"; ctx.textAlign = "center";
            if(Math.random() > 0.95) ctx.fillText("HE IS COMPLIANT", 640, 600);
        }

        // Subliminal Overlays
        if(Math.random() > 0.98) {
            ctx.fillStyle = "rgba(255,0,0,0.2)";
            ctx.fillRect(0,0,1280,720);
            playNote(40, 'sawtooth', 0.5, 0.2); // Jumpscare Audio
        }

        // Ticker
        ctx.fillStyle = "#000"; ctx.fillRect(0, 680, 1280, 40);
        ctx.fillStyle = "#0f0"; ctx.font = "20px VT323"; ctx.textAlign = "left";
        ctx.fillText("STATION_9 // " + state.wikiTexts[1] + " // " + state.keyword, 1280 - (state.frame*6 % 10000), 710);

        if(state.frame < state.maxFrames) requestAnimationFrame(render);
        else finish();
    }

    // --- 4. ENGINE & DOWNLOAD FIX ---
    async function start() {
        document.getElementById("ui-gate").style.display = "none";
        setupAudio();
        
        const stream = canvas.captureStream(60);
        const combined = new MediaStream([...stream.getVideoTracks(), ...state.audio.dest.stream.getAudioTracks()]);

        state.recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        state.recorder.ondataavailable = e => { if(e.data.size > 0) state.chunks.push(e.data); };
        
        state.recorder.onstop = () => {
            const blob = new Blob(state.chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            document.body.appendChild(a);
            a.style.display = 'none';
            a.href = url;
            a.download = `STATION9_RITUAL_${state.keyword.replace(/ /g,'_')}.webm`;
            a.click();
            setTimeout(() => { window.location.reload(); }, 5000);
        };

        state.recorder.start(100);
        state.active = true;
        render();

        const utter = new SpeechSynthesisUtterance(`Ritual sequence initiated. The topic is ${state.keyword}. Observe the polaroids carefully. The fiend is currently ${Math.floor(state.prox * 100)} percent manifested.`);
        utter.lang = 'en-US'; utter.pitch = 0.1; utter.rate = 0.75;
        window.speechSynthesis.speak(utter);
    }

    function finish() {
        state.active = false;
        state.recorder.stop();
    }

    init();
    startBtn.addEventListener("click", start);

})();
</script>
</body>
</html>
