<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ARCHIVE_V22 // UNIQUE_SEED</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=VT323&display=swap');
    body, html { margin: 0; padding: 0; background: #000; overflow: hidden; cursor: none; }
    #viewport { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
    canvas { width: 100%; height: 100%; object-fit: contain; filter: contrast(1.4) saturate(0) sepia(1) hue-rotate(180deg) brightness(0.8); image-rendering: pixelated; }
    
    /* CRT SCANLINES & VIGNETTE */
    .crt-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
        background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,1) 100%),
                    repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, transparent 2px, rgba(0,0,0,0.2) 4px);
        box-shadow: inset 0 0 100px #000; }
    
    #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000022; z-index: 100; color: #fff; 
        font-family: 'VT323', monospace; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .log-box { width: 600px; height: 300px; border: 2px solid #fff; padding: 20px; font-size: 18px; overflow: hidden; background: #000; margin-bottom: 20px; }
    button { background: #fff; color: #000; border: none; padding: 20px 50px; font-family: 'Special Elite', cursive; font-size: 24px; cursor: pointer; display: none; }
    button:hover { background: #f00; color: #fff; }
</style>
</head>
<body>

<div id="ui-layer">
    <div class="log-box" id="boot-log">
        > SYSTEM BOOT...<br>
        > CHECKING MEMORY BLACKLIST...<br>
    </div>
    <button id="start-btn">PLAY TAPE</button>
</div>

<div id="viewport">
    <div class="crt-overlay"></div>
    <canvas id="c"></canvas>
</div>

<script>
(function() {
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha: false });
    const logDiv = document.getElementById("boot-log");
    const startBtn = document.getElementById("start-btn");

    canvas.width = 1280;
    canvas.height = 720;

    // --- 1. UNIQUE SEED GENERATOR ---
    const ADJ = ["Bleeding", "Subliminal", "Geometric", "Hollow", "Recursive", "Silent", "Frozen", "Burning", "Rotting", "Deviant", "Forgotten", "Liminal", "Terminal"];
    const NOUN = ["Child", "Signal", "Corridor", "Archive", "Forest", "Machine", "Tooth", "Memory", "Static", "Video", "Lake", "Tunnel", "Hospital"];
    const KEYWORD = `${ADJ[Math.floor(Math.random()*ADJ.length)]}_${NOUN[Math.floor(Math.random()*NOUN.length)]}`;
    
    let STATE = {
        active: false,
        frame: 0,
        maxFrames: 3600, // 60s
        keyword: KEYWORD,
        wikiData: [],
        images: [],
        recorder: null,
        chunks: [],
        audio: null
    };

    function log(msg) {
        logDiv.innerHTML += `> ${msg}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // --- 2. UNIQUE CONTENT SCRAPER (With Blacklist) ---
    async function fetchUniqueContent() {
        log(`SEED: ${STATE.keyword}`);
        
        // A. WIKIPEDIA (Contextual Lore)
        // We search for the Keyword, or fall back to creepy topics if specific search fails
        const searchPool = [STATE.keyword.split('_')[1], "Paranormal", "Unsolved_disappearances", "Cryptid", "Numbers_station", "Mkultra", "Demonology"];
        const query = searchPool[Math.floor(Math.random() * searchPool.length)];
        
        try {
            log(`SEARCHING ARCHIVES FOR: ${query}...`);
            const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${query}`);
            const d = await r.json();
            
            // Session Blacklist Check
            const history = JSON.parse(sessionStorage.getItem('used_topics') || "[]");
            if(history.includes(d.title)) {
                log("DUPLICATE DETECTED. RETRYING...");
                STATE.wikiData = ["DATA CORRUPTED", "THE ARCHIVE IS EMPTY"];
            } else {
                history.push(d.title);
                sessionStorage.setItem('used_topics', JSON.stringify(history));
                STATE.wikiData = [d.title.toUpperCase(), (d.extract || "NO DATA FOUND").toUpperCase()];
            }
        } catch(e) { STATE.wikiData = ["UNKNOWN ERROR", "SIGNAL LOST"]; }

        // B. IMAGES (Picsum with seed based on Keyword + Random)
        log("DEVELOPING FILM...");
        const imgPromises = [];
        for(let i=0; i<6; i++) {
            imgPromises.push(new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                // Random seed ensures unique image every run, even with same keyword
                const seed = `${STATE.keyword}_${Math.random()}`; 
                img.src = `https://picsum.photos/seed/${seed}/800/600?grayscale`;
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null); // Fail gracefully
            }));
        }
        STATE.images = (await Promise.all(imgPromises)).filter(img => img !== null);
        log("ASSETS LOADED.");
        startBtn.style.display = "block";
    }

    // --- 3. AUDIO ENGINE (The "Brown Note" Drone) ---
    function initAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        const ac = new AC();
        const dest = ac.createMediaStreamDestination();
        const master = ac.createGain();
        master.connect(dest);
        master.connect(ac.destination);

        // 1. Low Drone (The Dread)
        const osc = ac.createOscillator();
        osc.frequency.value = 60; // Electrical hum
        const lfo = ac.createOscillator();
        lfo.frequency.value = 0.1; // Slow throb
        const gain = ac.createGain();
        gain.gain.value = 0.1;
        
        lfo.connect(gain.gain);
        osc.connect(gain).connect(master);
        osc.start(); lfo.start();

        // 2. Random Screeches (The Data)
        setInterval(() => {
            if(!STATE.active) return;
            if(Math.random() > 0.8) {
                const s = ac.createOscillator();
                s.type = "sawtooth";
                s.frequency.value = 1000 + Math.random() * 5000;
                const sg = ac.createGain();
                sg.gain.value = 0.05;
                sg.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.2);
                s.connect(sg).connect(master);
                s.start(); s.stop(ac.currentTime + 0.2);
            }
        }, 100);

        STATE.audio = { ctx: ac, dest: dest };
    }

    // --- 4. VISUAL FX: PIXEL MELT & FIEND ---
    function meltEffect(intensity) {
        if(intensity <= 0) return;
        const w = canvas.width;
        const h = canvas.height;
        // Grab random slices
        for(let i=0; i<10; i++) {
            const x = Math.floor(Math.random() * w);
            const y = Math.floor(Math.random() * h);
            const sw = Math.random() * 100;
            const sh = Math.random() * 200;
            
            // Draw that slice slightly lower
            ctx.drawImage(canvas, x, y, sw, sh, x, y + (Math.random()*10), sw, sh);
        }
    }

    function drawTheFiend(p) {
        // The Fiend is a composite of shadows
        const x = 640;
        const y = 360;
        const s = 1 + (p * 2); // Scales up

        ctx.save();
        ctx.translate(x, y);
        ctx.scale(s, s);
        
        // Jitter
        const jx = (Math.random()-0.5) * 20;
        const jy = (Math.random()-0.5) * 20;
        ctx.translate(jx, jy);

        // Body (Shadow)
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.ellipse(0, 50, 60, 120, 0, 0, Math.PI*2);
        ctx.fill();

        // Face (Inverted Composite)
        if(STATE.images[0]) {
            ctx.globalCompositeOperation = "source-atop";
            ctx.drawImage(STATE.images[0], -50, -50, 100, 100);
            ctx.globalCompositeOperation = "difference"; // Makes it look like a negative
            ctx.fillStyle = "#fff";
            ctx.fillRect(-40, -20, 80, 20); // Eyes redaction
        }
        
        ctx.restore();
        ctx.globalCompositeOperation = "source-over";
    }

    function draw() {
        if(!STATE.active) return;
        STATE.frame++;
        const p = STATE.frame / STATE.maxFrames;
        
        // Background
        ctx.fillStyle = (Math.random() > 0.95) ? "#111" : "#050505";
        ctx.fillRect(0,0,1280,720);

        // SCENES
        if(p < 0.3) {
            // SCENE 1: THE DOSSIER
            ctx.fillStyle = "#ddd"; ctx.font = "40px 'Special Elite'";
            ctx.fillText("CASE FILE: " + STATE.keyword, 100, 100);
            ctx.font = "20px 'VT323'";
            const txt = STATE.wikiData[1].match(/.{1,60}/g) || ["DATA CORRUPTED"];
            txt.slice(0, 15).forEach((line, i) => ctx.fillText(line, 100, 200 + (i*25)));
            
            // Image Flash
            if(STATE.frame % 60 < 20) {
                const img = STATE.images[Math.floor(Math.random()*STATE.images.length)];
                if(img) ctx.drawImage(img, 800, 100, 400, 300);
            }

        } else if (p < 0.7) {
            // SCENE 2: THE EVIDENCE (MELTING)
            const img = STATE.images[1];
            if(img) {
                ctx.save();
                ctx.translate(640, 360);
                ctx.rotate(Math.sin(STATE.frame*0.01)*0.1);
                ctx.drawImage(img, -300, -225, 600, 450);
                ctx.restore();
            }
            meltEffect(0.5); // HEAVY MELT

            ctx.fillStyle = "red"; ctx.font = "bold 60px 'VT323'";
            if(STATE.frame % 30 < 15) ctx.fillText("DO NOT LOOK", 500, 600);

        } else {
            // SCENE 3: THE MANIFESTATION
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,1280,720); // Flashbang
            if(Math.random() > 0.1) {
                ctx.fillStyle = "#000"; ctx.fillRect(0,0,1280,720);
                drawTheFiend(p);
            }
            
            ctx.fillStyle = "#fff"; ctx.font = "30px 'VT323'";
            ctx.fillText(STATE.wikiData[0], 50, 680);
        }

        // POST PROCESSING
        // Scanlines
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        for(let i=0; i<720; i+=4) ctx.fillRect(0,i,1280,2);
        
        // Random Text Jumpscare
        if(Math.random() > 0.99) {
            ctx.fillStyle = "white"; ctx.font = "100px 'Special Elite'";
            ctx.fillText("WAKE UP", 400, 400);
        }

        if(STATE.frame < STATE.maxFrames) requestAnimationFrame(draw);
        else finish();
    }

    // --- 5. RECORDING & EXPORT ---
    async function start() {
        document.getElementById("ui-layer").style.display = "none";
        initAudio();

        const stream = canvas.captureStream(30); // 30 FPS for that distinct VHS feel
        const combined = new MediaStream([...stream.getVideoTracks(), ...STATE.audio.dest.stream.getAudioTracks()]);
        
        // Robust Codec Check
        let mime = "video/webm";
        if(MediaRecorder.isTypeSupported("video/webm;codecs=vp9")) mime = "video/webm;codecs=vp9";
        else if(MediaRecorder.isTypeSupported("video/webm;codecs=vp8")) mime = "video/webm;codecs=vp8";

        STATE.recorder = new MediaRecorder(combined, { mimeType: mime, videoBitsPerSecond: 5000000 });
        STATE.recorder.ondataavailable = e => STATE.chunks.push(e.data);
        STATE.recorder.onstop = save;
        STATE.recorder.start();
        STATE.active = true;
        
        // SPEECH SYNTHESIS (Uncanny)
        const u = new SpeechSynthesisUtterance(`Subject ${STATE.keyword}. ${STATE.wikiData[0]}. The evidence is degrading. You must stop watching.`);
        u.pitch = 0.5; u.rate = 0.8;
        window.speechSynthesis.speak(u);

        draw();
    }

    function finish() {
        STATE.active = false;
        STATE.recorder.stop();
    }

    function save() {
        const blob = new Blob(STATE.chunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = `CASE_${STATE.keyword}_EVIDENCE.webm`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => window.location.reload(), 2000); // Auto-reload for new seed
    }

    fetchUniqueContent();
    startBtn.addEventListener("click", start);

})();
</script>
</body>
</html>
