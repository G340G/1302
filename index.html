<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MISSING PERSON ALERT // ARCHIVE_V23</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=VT323&family=Courier+Prime&display=swap');
*{margin:0;padding:0;box-sizing:border-box}body,html{background:#000;overflow:hidden;cursor:none;font-family:'Courier Prime',monospace}
#viewport{position:relative;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center}
canvas{width:100%;height:100%;object-fit:contain;filter:contrast(1.4) saturate(0.2) sepia(0.4) brightness(0.9);image-rendering:pixelated}
.vhs-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.15) 0px,transparent 2px,transparent 3px,rgba(0,0,0,0.15) 4px),repeating-linear-gradient(90deg,rgba(255,0,0,0.03),rgba(0,255,0,0.02),rgba(0,0,255,0.03));background-size:100% 4px,3px 100%;mix-blend-mode:overlay;animation:vhsScan 8s linear infinite}
@keyframes vhsScan{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
#boot-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:200;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#0f0;font-family:'VT323',monospace;padding:40px}
.terminal{width:800px;max-width:90%;text-align:left;font-size:20px;line-height:1.5;border:3px solid #0f0;padding:30px;background:rgba(0,20,0,0.9);box-shadow:inset 0 0 100px rgba(0,255,0,0.1),0 0 30px rgba(0,255,0,0.3)}
.blink{animation:blink 1s infinite}@keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}
#init-btn{margin-top:40px;padding:20px 60px;background:#0f0;color:#000;border:none;font-family:'Special Elite',cursive;font-size:24px;cursor:pointer;text-transform:uppercase;letter-spacing:3px;transition:all 0.3s;display:none;box-shadow:0 0 20px rgba(0,255,0,0.5)}
#init-btn:hover{background:#f00;color:#fff;box-shadow:0 0 30px rgba(255,0,0,0.8);transform:scale(1.05)}
.warning{color:#f00;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
</style>
</head>
<body>
<div id="boot-screen">
<div class="terminal">
<div id="boot-text"></div>
<span class="blink">▊</span>
</div>
<button id="init-btn">INITIATE ARCHIVE</button>
</div>
<div id="viewport">
<div class="vhs-overlay"></div>
<canvas id="canvas"></canvas>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
<script>
(function(){
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{alpha:false});
canvas.width=1920;
canvas.height=1080;

// --- MILLION-WORD GENERATOR ---
const SEED_ADJ = ["Bleeding", "Subliminal", "Geometric", "Hollow", "Recursive", "Silent", "Frozen", "Burning", "Rotting", "Deviant", "Forgotten", "Liminal", "Terminal", "Inverted", "Parasitic"];
const SEED_NOUN = ["Child", "Signal", "Corridor", "Archive", "Forest", "Machine", "Tooth", "Memory", "Static", "Video", "Lake", "Tunnel", "Hospital", "Frequency", "Organism"];
const KEYWORD = `${_.sample(SEED_ADJ)}_${_.sample(SEED_NOUN)}`;

let STATE={
    active:false,
    frame:0,
    maxFrames:3600, // Extended length
    scene:0,
    victim:null,
    evidence:[],
    testimonies:[],
    images:[],
    glitchIntensity:0,
    fiendProximity:0,
    audioContext:null,
    audioDestination:null,
    recorder:null,
    chunks:[],
    coordinates:"",
    phone:"",
    caseNumber:"",
    pattern:[],
    distortedSpeech:null,
    seedKeyword: KEYWORD // The guiding seed
};

const FIRST_NAMES=["Sarah","Michael","Emily","David","Jessica","Christopher","Amanda","Matthew","Ashley","Joshua","Megan","Daniel","Lauren","James","Rebecca"];
const LAST_NAMES=["Anderson","Mitchell","Parker","Collins","Morrison","Bennett","Sullivan","Harrison","Fletcher","Coleman","Henderson","Martinez","Wallace","Griffin","Hayes"];
const LOCATIONS=["Oakwood Shopping Center","County Road 47","Riverside Park","Downtown Bus Station","Miller's Gas Station","Highway 19 Rest Stop","Lakewood Apartments","State Route 6","Valley View Mall","Pine Creek Trail"];
const DATES=["March 15, 1983","July 22, 1998","October 8, 1985","January 3, 2001","September 17, 1999","May 29, 2004","December 11, 2002","August 6, 2000","April 23, 1997","November 14, 2006"];
const ADJECTIVES=["Impossible","Recursive","Inverted","Bleeding","Hollow","Writhing","Dormant","Crystalline","Spectral","Aberrant","Cascading","Fractured","Ambient","Malignant"];
const NOUNS=["Geometry","Frequency","Threshold","Witness","Aperture","Signal","Membrane","Protocol","Vessel","Lattice","Corridor","Substrate","Echo","Manifestation"];
const VERBS=["Convergence","Dissolution","Inhabitation","Propagation","Severance","Transference","Consumption","Integration","Emergence","Resonance"];

function generateVictim(){
    const first=_.sample(FIRST_NAMES);
    const last=_.sample(LAST_NAMES);
    const age=16+Math.floor(Math.random()*25);
    const height=`5'${4+Math.floor(Math.random()*8)}"`;
    const weight=110+Math.floor(Math.random()*90);
    const tops=["blue denim jacket","red hoodie","gray sweater","black leather jacket","white t-shirt"];
    const bottoms=["blue jeans","black pants","khaki shorts","dark skirt"];
    return{
        name:`${first} ${last}`,
        age:age,
        height:height,
        weight:weight,
        lastSeen:_.sample(LOCATIONS),
        date:_.sample(DATES),
        wearing:`${_.sample(tops)}, ${_.sample(bottoms)}`,
        caseNum:`MP-${Math.floor(Math.random()*90000)+10000}`
    }
}

function generateCoordinates(){
    const lat=(35+Math.random()*15).toFixed(6);
    const lon=(-120+Math.random()*30).toFixed(6);
    return`${lat}°N ${lon}°W`;
}

function generatePhone(){
    return`(${Math.floor(Math.random()*900)+100}) ${Math.floor(Math.random()*900)+100}-${Math.floor(Math.random()*9000)+1000}`;
}

function generatePattern(){
    const base=Math.floor(Math.random()*30)+10;
    return[base,base*2,base*3,base*5,base*7,base*11];
}

const BOOT_SEQUENCE=[
    "> INITIALIZING SEPHIROTH_V23...",
    "> GENERATING ENTROPY SEED: " + STATE.seedKeyword,
    "> SCRAPING ARCHIVE...",
    "> STATION_9 SIGNAL DETECTED",
    "",
    "> SUBJECT DESIGNATION: [GENERATING...]",
    "> LAST KNOWN COORDINATES: [TRIANGULATING...]",
    "> WITNESS TESTIMONIES: [COMPILING...]",
    "",
    "<span class='warning'>> CRITICAL: THE ARCHIVE IS LEAKING</span>",
    "<span class='warning'>> DO NOT DISTRIBUTE. DO NOT RECORD.</span>",
    "",
    "> ANOMALOUS PATTERNS DETECTED IN FOOTAGE",
    "> RECOMMENDATION: TERMINATION",
    "",
    "<span class='warning'>> OVERRIDE ACCEPTED</span>",
    "<span class='warning'>> PLAYBACK WILL COMMENCE IN 3...</span>",
    "<span class='warning'>> 2...</span>",
    "<span class='warning'>> 1...</span>"
];

let bootLine=0;
function typeBootSequence(){
    if(bootLine>=BOOT_SEQUENCE.length){
        document.getElementById("init-btn").style.display="block";
        return;
    }
    const bootText=document.getElementById("boot-text");
    bootText.innerHTML+=BOOT_SEQUENCE[bootLine]+"<br>";
    bootLine++;
    setTimeout(typeBootSequence,150+Math.random()*200);
}

// --- UPDATED IMAGE FETCHER (Seeded) ---
async function fetchCreepyImages(){
    console.log('Fetching images for seed:', STATE.seedKeyword);
    const promises=[];
    
    // We fetch more images to handle the slides
    for(let i=0; i<15; i++) {
        promises.push(new Promise((resolve)=>{
            const img=new Image();
            img.crossOrigin="anonymous";
            // Uses the keyword + index as seed to ensure unique but consistent images for this run
            const uniqueSeed = `${STATE.seedKeyword}_${i}_${Math.random()}`;
            img.onload=()=>resolve(img);
            img.onerror=()=>{
                const fallback=generateProceduralImage(Math.random()*999999,['face','forest','static','room'][i%4]);
                resolve(fallback);
            };
            img.src=`https://picsum.photos/seed/${uniqueSeed}/1200/800?grayscale&blur=2`;
        }));
    }
    return Promise.all(promises);
}

// --- UPDATED TEXT FETCHER (Contextual) ---
async function fetchCreepyText(){
    // Mix generic creepy topics with the Generated Keyword
    const topics=[
        STATE.seedKeyword.split('_')[1], // The Noun (e.g., "Corridor")
        "Paranormal", "Unexplained_disappearance", "Cryptid", 
        "Numbers_station", "Electronic_voice_phenomenon", "Shadow_person"
    ];

    const selectedTopics=_.shuffle(topics).slice(0,3);
    const testimonies=[];

    for(const topic of selectedTopics){
        try{
            const response=await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${topic}`);
            if(!response.ok)throw new Error('Failed');
            const data=await response.json();
            if(data.extract){
                const sentences=data.extract.split(/[.!?]+/).filter(s=>s.trim().length>20);
                if(sentences.length > 0) testimonies.push(_.sample(sentences).trim().toUpperCase());
            }
        } catch(e){ console.warn('Wiki scrape failed for',topic); }
    }

    // Add Procedural Fallbacks using the Keyword
    if(testimonies.length<5){
        testimonies.push(
            `THE ${STATE.seedKeyword.replace('_',' ')} WAS SEEN MOVING ON ITS OWN.`,
            "SECURITY FOOTAGE SHOWS IMPOSSIBLE GEOMETRY.",
            "THE SIGNAL IS COMING FROM INSIDE THE WALLS.",
            "WITNESSES REPORT A METALLIC TASTE IN THE AIR."
        );
    }
    return testimonies;
}

function generateProceduralImage(seed,type){
    const tempCanvas=document.createElement('canvas');
    tempCanvas.width=1200; tempCanvas.height=800;
    const tempCtx=tempCanvas.getContext('2d');
    const rng=()=>{seed=(seed*9301+49297)%233280;return seed/233280};

    // Keep original procedural logic as fallback
    if(type==='face'){
        tempCtx.fillStyle='#0a0a0a'; tempCtx.fillRect(0,0,1200,800);
        tempCtx.fillStyle='#2a2a2a'; tempCtx.beginPath(); tempCtx.ellipse(600,400,250,350,0,0,Math.PI*2); tempCtx.fill();
        tempCtx.fillStyle='#000'; tempCtx.fillRect(480,320,80,100); tempCtx.fillRect(640,320,80,100);
    } else if (type==='static') {
        for(let i=0;i<1200;i+=4){
            for(let j=0;j<800;j+=4){
                const v=rng()*255; tempCtx.fillStyle=`rgb(${v},${v},${v})`; tempCtx.fillRect(i,j,4,4);
            }
        }
    } else {
        tempCtx.fillStyle='#111'; tempCtx.fillRect(0,0,1200,800);
        for(let i=0;i<50;i++) {
            tempCtx.fillStyle='rgba(255,255,255,0.1)';
            tempCtx.fillRect(rng()*1200, rng()*800, rng()*100, rng()*100);
        }
    }
    const img=new Image(); img.src=tempCanvas.toDataURL(); return img;
}

async function initialize(){
    STATE.victim=generateVictim();
    STATE.coordinates=generateCoordinates();
    STATE.phone=generatePhone();
    STATE.caseNumber=STATE.victim.caseNum;
    STATE.pattern=generatePattern();

    for(let i=0;i<3;i++) STATE.evidence.push(`${_.sample(ADJECTIVES)} ${_.sample(NOUNS)} ${_.sample(VERBS)}`);
    
    STATE.images=await fetchCreepyImages();
    STATE.testimonies=await fetchCreepyText();
    typeBootSequence();
}

function setupAudio(){
    const AudioContext=window.AudioContext||window.webkitAudioContext;
    STATE.audioContext=new AudioContext();
    STATE.audioDestination=STATE.audioContext.createMediaStreamDestination();
    const masterGain=STATE.audioContext.createGain();
    masterGain.gain.value=0.6;
    masterGain.connect(STATE.audioDestination);
    masterGain.connect(STATE.audioContext.destination);

    // Complex Drone
    const droneLFO=STATE.audioContext.createOscillator();
    const droneGain=STATE.audioContext.createGain();
    droneLFO.type='sine'; droneLFO.frequency.value=0.1; droneGain.gain.value=20;
    const drone=STATE.audioContext.createOscillator();
    drone.type='sawtooth'; // Changed to sawtooth for harsher sound
    drone.frequency.value=40;
    droneLFO.connect(droneGain); droneGain.connect(drone.frequency);
    const lowPass=STATE.audioContext.createBiquadFilter();
    lowPass.type='lowpass'; lowPass.frequency.value=150;
    drone.connect(lowPass).connect(masterGain);
    drone.start(); droneLFO.start();

    // Binaural Beats
    const binauralL=STATE.audioContext.createOscillator();
    const binauralR=STATE.audioContext.createOscillator();
    const binauralGain=STATE.audioContext.createGain();
    const merger=STATE.audioContext.createChannelMerger(2);
    binauralL.frequency.value=200; binauralR.frequency.value=207; // 7Hz difference (Theta waves)
    binauralGain.gain.value=0.05;
    binauralL.connect(merger,0,0); binauralR.connect(merger,0,1);
    merger.connect(binauralGain); binauralGain.connect(masterGain);
    binauralL.start(); binauralR.start();

    // Random Glitch Sounds
    setInterval(()=>{
        if(!STATE.active)return;
        const freq=80+Math.random()*600;
        const osc=STATE.audioContext.createOscillator();
        const gain=STATE.audioContext.createGain();
        osc.type=_.sample(['square','sawtooth']);
        osc.frequency.setValueAtTime(freq,STATE.audioContext.currentTime);
        gain.gain.setValueAtTime(0.1+STATE.glitchIntensity*0.2,STATE.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001,STATE.audioContext.currentTime+0.4);
        osc.connect(gain); gain.connect(masterGain);
        osc.start(); osc.stop(STATE.audioContext.currentTime+0.4);
    },800+Math.random()*1200);

    // EAS Tones
    setInterval(()=>{
        if(!STATE.active||Math.random()>0.2)return; // Increased frequency
        const eas1=STATE.audioContext.createOscillator();
        const eas2=STATE.audioContext.createOscillator();
        const easGain=STATE.audioContext.createGain();
        eas1.frequency.value=853; eas2.frequency.value=960;
        easGain.gain.value=0.15;
        eas1.connect(easGain); eas2.connect(easGain); easGain.connect(masterGain);
        eas1.start(); eas2.start();
        setTimeout(()=>{eas1.stop();eas2.stop()},200);
    },5000);
}

function createDistortedSpeech(text){
    const utterance=new SpeechSynthesisUtterance(text);
    utterance.pitch=0.6; // Lower pitch
    utterance.rate=0.8;
    utterance.volume=1.0;
    utterance.lang='en-US';
    window.speechSynthesis.speak(utterance);
}

function drawVHSTimestamp(){
    const date=new Date(STATE.victim.date);
    const hours=Math.floor(STATE.frame/3600)+(Math.random()>0.98?Math.floor(Math.random()*24):9);
    const mins=Math.floor((STATE.frame%3600)/60);
    const secs=STATE.frame%60;
    ctx.fillStyle="rgba(0, 0, 0, 0.8)";
    ctx.fillRect(20,20,400,80);
    ctx.fillStyle="#fff"; ctx.font="28px VT323";
    ctx.fillText(`REC ●`,35,50);
    ctx.fillText(`${date.getMonth()+1}/${date.getDate()}/${date.getFullYear()}`,35,80);
    ctx.fillText(`${String(hours).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`,250,80);
}

function drawMissingPersonPoster(){
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,1920,1080);
    ctx.fillStyle="#c00"; ctx.fillRect(0,0,1920,200);
    ctx.fillStyle="#fff"; ctx.font="bold 120px Special Elite"; ctx.textAlign="center";
    ctx.fillText("MISSING PERSON",960,140);
    ctx.fillStyle="#000"; ctx.fillRect(560,250,800,1000);

    // Use specific images for the poster
    const img=STATE.images[0];
    if(img&&img.complete){
        ctx.save();
        ctx.globalAlpha=0.8;
        // Jitter effect
        const jx = (Math.random()-0.5)*10;
        ctx.drawImage(img,560+jx,250,800,600);
        ctx.restore();
    }

    ctx.fillStyle="#000"; ctx.font="bold 60px Courier Prime"; ctx.textAlign="left";
    ctx.fillText(STATE.victim.name.toUpperCase(),150,1400); // Intentionally off-screen in original? Bringing up
    ctx.fillText(STATE.victim.name.toUpperCase(),150,900);
    ctx.font="40px Courier Prime";
    ctx.fillText(`AGE: ${STATE.victim.age} | HEIGHT: ${STATE.victim.height}`,150,960);
    ctx.fillText(`LAST SEEN: ${STATE.victim.lastSeen}`,150,1020);
    
    ctx.fillStyle="#c00"; ctx.font="bold 70px Special Elite"; ctx.textAlign="center";
    let displayPhone=STATE.phone;
    if(Math.random()>0.7) displayPhone=displayPhone.replace(/\d/g,()=>Math.floor(Math.random()*10));
    ctx.fillText(`CONTACT: ${displayPhone}`,960,1000);
}

function drawEvidenceBoard(){
    ctx.fillStyle="#222"; ctx.fillRect(0,0,1920,1080);
    // Draw connecting strings
    ctx.strokeStyle="#f00"; ctx.lineWidth=2; ctx.beginPath();
    ctx.moveTo(400,400); ctx.lineTo(960,540); ctx.lineTo(1500,400); ctx.stroke();

    for(let i=0;i<5;i++){
        const x=300+(i%3)*600;
        const y=300+Math.floor(i/3)*400;
        drawPolaroid(x,y,i,10*(Math.sin(STATE.frame*0.02+i)));
    }
    
    ctx.fillStyle="#fff"; ctx.fillRect(100,850,1720,200);
    ctx.fillStyle="#000"; ctx.font="32px Special Elite"; ctx.textAlign="left";
    const note=STATE.testimonies[Math.floor(STATE.frame/400)%STATE.testimonies.length]||"DATA CORRUPTED";
    const wrapped=note.match(/.{1,75}/g)||[note];
    wrapped.slice(0,3).forEach((line,i)=>ctx.fillText(line,120,900+i*40));
}

function drawPolaroid(x,y,index,rotation){
    ctx.save();
    ctx.translate(x,y); ctx.rotate(rotation*Math.PI/180);
    ctx.fillStyle="#eee"; ctx.fillRect(-150,-180,300,350);
    ctx.fillStyle="#111"; ctx.fillRect(-140,-170,280,280);

    const img=STATE.images[index+1];
    if(img&&img.complete){
        ctx.drawImage(img,-140,-170,280,280);
        // Melt Effect
        if(Math.random()<0.3) {
            const stripW = Math.random()*280;
            ctx.drawImage(img, 0, 0, 100, 100, -140, -170+Math.random()*100, stripW, 280);
        }
    }
    
    ctx.fillStyle="#000"; ctx.font="20px Special Elite"; ctx.textAlign="center";
    ctx.fillText(`EXHIBIT ${String(index+1).padStart(2,'0')}`,0,140);
    ctx.restore();
}

function drawStaticTransition(){
    const imageData=ctx.createImageData(1920,1080);
    const data=imageData.data;
    for(let i=0;i<data.length;i+=4){
        const val=Math.random()*255;
        data[i]=val; data[i+1]=val; data[i+2]=val; data[i+3]=255;
    }
    ctx.putImageData(imageData,0,0);
}

function drawFoundFootage(){
    ctx.fillStyle="#000"; ctx.fillRect(0,0,1920,1080);
    const img=STATE.images[5+(Math.floor(STATE.frame/60)%4)]; // Rapid switching
    if(img&&img.complete){
        const shakeX=(Math.random()-0.5)*50;
        const shakeY=(Math.random()-0.5)*50;
        ctx.save(); ctx.translate(960+shakeX,540+shakeY);
        ctx.globalAlpha=0.6;
        ctx.drawImage(img,-960,-540,1920,1080);
        ctx.restore();
    }
    // Night Vision Tint
    ctx.fillStyle="rgba(0, 255, 0, 0.1)"; ctx.fillRect(0,0,1920,1080);
}

function drawTheFiend(){
    // Uncanny Composite Fiend
    ctx.fillStyle="#000"; ctx.fillRect(0,0,1920,1080);
    const p = STATE.fiendProximity;
    
    ctx.save();
    ctx.translate(960, 540);
    ctx.scale(1+p*2, 1+p*2);
    
    // Shadow Body
    ctx.fillStyle="#050505";
    ctx.beginPath(); ctx.ellipse(0,0,150,300,0,0,Math.PI*2); ctx.fill();

    // Composite Face (Scary)
    const faceImg = STATE.images[0];
    if(faceImg && faceImg.complete) {
        ctx.globalCompositeOperation = 'difference';
        ctx.drawImage(faceImg, -100, -100, 200, 200);
        ctx.globalCompositeOperation = 'source-over';
    }

    // Glowing Eyes
    ctx.fillStyle="#fff";
    ctx.shadowBlur=20; ctx.shadowColor="#fff";
    if(Math.random()>0.1) {
        ctx.fillRect(-40,-50,10,10);
        ctx.fillRect(40,-50,10,10);
    }
    
    ctx.restore();

    if(p>0.8){
        ctx.fillStyle="#f00"; ctx.font="bold 100px Special Elite"; ctx.textAlign="center";
        ctx.fillText("HE SEES YOU",960,900);
    }
}

function drawNewsChyron(){
    ctx.fillStyle="#c00"; ctx.fillRect(0,980,1920,100);
    ctx.fillStyle="#fff"; ctx.font="bold 40px Courier Prime"; ctx.textAlign="left";
    const newsItems=[
        `BREAKING: ${STATE.victim.name.toUpperCase()} MISSING`,
        `CASE: ${STATE.caseNumber}`,
        `TOPIC: ${STATE.seedKeyword}`,
        `LAST SEEN: ${STATE.victim.lastSeen}`,
        `WITNESS: "${STATE.testimonies[0] || 'SILENCE'}"`,
        `DO NOT ATTEMPT TO CONTACT`
    ];
    const scrollX=1920-((STATE.frame*8)%(newsItems.join(' /// ').length*25+1920));
    ctx.fillText(newsItems.join(' /// '),scrollX,1040);
}

function applyGlitchEffects(){
    if(Math.random()<0.05){
        const h = Math.random()*200;
        const y = Math.random()*1080;
        ctx.drawImage(canvas, 0, y, 1920, h, Math.random()*40-20, y, 1920, h);
    }
    if(Math.random()<0.01) {
        ctx.fillStyle="#fff"; ctx.fillRect(0,0,1920,1080); // Subliminal Flash
    }
}

function render(){
    if(!STATE.active)return;
    STATE.frame++;
    STATE.scene=Math.floor(STATE.frame/600)%6; // Slower scene changes
    STATE.fiendProximity=Math.pow(STATE.frame/STATE.maxFrames,2);
    
    switch(STATE.scene){
        case 0:drawMissingPersonPoster();break;
        case 1:drawEvidenceBoard();break;
        case 2:drawFoundFootage();break;
        case 3:drawStaticTransition();break;
        case 4:drawEvidenceBoard();break; // More evidence
        case 5:drawTheFiend();break;
    }
    
    drawVHSTimestamp();
    drawNewsChyron();
    applyGlitchEffects();
    
    if(STATE.frame<STATE.maxFrames){
        requestAnimationFrame(render);
    }else{
        finishRecording();
    }
}

function startRecording(){
    document.getElementById("boot-screen").style.display="none";
    setupAudio();
    const videoStream=canvas.captureStream(60);
    const audioStream=STATE.audioDestination.stream;
    const combinedStream=new MediaStream([...videoStream.getVideoTracks(),...audioStream.getAudioTracks()]);
    
    // --- CODEC FIX ---
    let mimeType = 'video/webm;codecs=vp9,opus';
    if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm;codecs=vp8,opus';
    if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm';

    STATE.recorder=new MediaRecorder(combinedStream,{
        mimeType: mimeType,
        videoBitsPerSecond:5000000
    });
    
    STATE.recorder.ondataavailable=(e)=>{
        if(e.data.size>0)STATE.chunks.push(e.data);
    };
    
    STATE.recorder.onstop=()=>{
        const blob=new Blob(STATE.chunks,{type:'video/webm'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.style.display='none';
        a.href=url;
        a.download=`CASE_${STATE.victim.name.replace(/ /g,'_')}_${STATE.seedKeyword}.webm`;
        document.body.appendChild(a); // Append fix
        a.click();
        setTimeout(()=>{
            URL.revokeObjectURL(url);
            window.location.reload();
        },5000); // Longer wait
    };
    
    STATE.recorder.start(100);
    STATE.active=true;
    render();

    const intro=`This is an automated archive alert. Subject ${STATE.victim.name}. Keyword ${STATE.seedKeyword}. The footage you are about to see is classified.`;
    createDistortedSpeech(intro);
}

function finishRecording(){
    STATE.active=false;
    if(STATE.recorder&&STATE.recorder.state!=='inactive'){
        STATE.recorder.stop();
    }
}

window.speechSynthesis.onvoiceschanged=()=>{};
initialize();
document.getElementById("init-btn").addEventListener("click",startRecording);
})();
</script>
</body>
</html>
